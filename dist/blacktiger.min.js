"use strict";var $btmod=angular.module("blacktiger",["ngCookies","ngResource","LocalStorageModule"]);$btmod.provider("blacktiger",function(){var a="",b=window.name;b&&""!==b||(window.name=(new Date).getTime(),b=window.name);var c=function(b){"/"!==b.charAt(b.length-1)&&(b+="/"),a=b};this.setServiceUrl=c,this.$get=function(){return{getServiceUrl:function(){return a},setServiceUrl:c,getInstanceId:function(){return b}}}}),$btmod.factory("AutoCommentRequestCancelSvc",["$rootScope","$timeout","CONFIG","$log",function(a,b,c,d){var e=[],f=c.commentRequestTimeout,g=!1;angular.isNumber(f)||(f=15e3);var h=function(a,c){d.debug("Updating cancel promise. [channel="+a+";newPromise="+c+"]"),e[a]&&b.cancel(e[a]),c?e[a]=c:delete e[a]};return a.$on("PushEvent.CommentRequest",function(c,e,i){if(g){d.debug("CommentRequest intercepted. Creating new timeout.");var j=b(function(){d.debug("Broadcasting CommentRequestCancel event. [room="+e+";channel="+i+"]"),a.$broadcast("PushEvent.CommentRequestCancel",e,i)},f);h(i,j)}}),a.$on("PushEvent.CommentRequestCancel",function(a,b,c){g&&(d.debug("CommentRequestCancel intercepted. Cancelleing any related timeouts."),h(c))}),{start:function(){g=!0},stop:function(){g=!1}}}]),$btmod.factory("HistorySvc",["$rootScope","$cookieStore","blacktiger","$log",function(a,b,c,d){d.debug("Initializing HistorySvc");var e="meetingHistory-"+c.getInstanceId(),f=b.get(e),g=function(a){var b=0,c=new Date;return angular.forEach(a.calls,function(a){b+=null!==a.end?a.end-a.start:c.getTime()-a.start}),b},h=function(){a.$broadcast("History.Updated")},i=function(){d.debug("Resetting history data"),f={},b.put(e,{}),h()};f&&angular.isObject(f)||i();var j=function(a){d.debug("Creating new entry."),f[a]={}},k=function(a,b,c){d.debug("HistorySvc:handleConferenceStart");var e;if(void 0===f[b.id]&&j(b.id),angular.isArray(b.participants))for(d.debug("Conference had "+b.participants.length+" participants. Emitting them as events."),e=0;e<b.participants.length;e++)l(void 0,b.id,b.participants[e],c)},l=function(a,c,g,i){d.debug("HistorySvc:handleJoinEvent");var k,l,m,n;if(!g.host){if(angular.isDefined(f[c])||j(c),!angular.isDefined(g.callerId))throw"Participant does not have a callerId specified.";k=f[c],n=g.callerId,d.debug("New participant - adding to history [key="+n+"]."),void 0===k[n]?(d.debug("Participant has no entry. Creating new entry."),l={type:g.type,callerId:g.callerId,phoneNumber:g.phoneNumber,name:g.name,firstCall:(new Date).getTime(),calls:[],channel:g.channel,totalDuration:0},k[n]=l):(l=k[n],l.channel=g.channel),i&&l.calls.length>0?(d.debug("Resuming last call in call list for participant."),l.calls[l.calls.length-1].end=null):(d.debug("Appending new call to call list for participant."),m={start:(new Date).getTime(),end:null},l.calls.push(m)),d.debug("Persisting history."),b.put(e,f),h()}},m=function(a,c,i){d.debug("HistorySvc:handleLeaveEvent");var k,l,m,n,o,p=!1;angular.isDefined(f[c])||j(c),k=f[c];for(n in k)if(l=k[n],l.channel===i){for(m=0;m<l.calls.length;m++)o=l.calls[m],null===o.end&&(o.end=(new Date).getTime(),p=!0);l.totalDuration=g(l)}p&&(b.put(e,f),h())},n=function(a,c,g){d.debug("HistorySvc:handlePhoneBookUpdate"),angular.forEach(f,function(a){angular.forEach(a,function(a){c===a.phoneNumber&&(a.name=g)})}),b.put(e,f),h()},o=function(a,b,c){if(a&&!angular.isString(a))throw"Room must be specified as String.";var e,g,h,i,j,k,l,m=[];d.debug("Finding entries [room="+a+";callerId="+b+";active="+c+"]");for(l in f)if(!angular.isDefined(a)||a===l)for(e in f[l]){if(k=!0,h=!1,g=f[l][e],angular.isDefined(b)&&(k=g.callerId===b),angular.isDefined(c)){for(h=!1,i=0;i<g.calls.length;i++)if(j=g.calls[i],null===j.end){h=!0;break}h!==c&&(k=!1)}k&&m.push(angular.copy(g))}return d.debug("Found "+m.length+" entries"),m};return a.$on("PushEvent.ConferenceStart",k),a.$on("PushEvent.Join",l),a.$on("PushEvent.Leave",m),a.$on("PhoneBook.Update",n),{getTotalDurationByRoomAndCallerId:function(a,b){var c=0,e=o(angular.isObject(a)?a.id:a,b);return e&&e.length>0?c=g(e[0]):d.debug("HistorySvc.getTotalDurationByRoomAndCallerId: No entry found [room="+a+";callerId="+b+"]"),c},findOneByRoomAndCallerId:function(a,b){var c=o(angular.isObject(a)?a.id:a,b);return 0===c.length?null:c[0]},deleteAll:function(){i()},findAll:function(){return o()},findAllByRoom:function(a){return o(angular.isObject(a)?a.id:a)},findAllByActive:function(a){return o(void 0,void 0,a)},findAllByRoomAndActive:function(a,b){return o(angular.isObject(a)?a.id:a,void 0,b)},getCookieName:function(){return e}}}]),$btmod.factory("LoginSvc",["$q","localStorageService","$http","$rootScope","blacktiger","$log",function(a,b,c,d,e,f){var g=null;return{authenticate:function(h,i,j){var k,l,m=null;return h||i?h&&i&&(l=btoa(h+":"+i)):l=b.get("LoginToken"),l?(k="Basic "+l,c.get(e.getServiceUrl()+"system/authenticate",{headers:{Authorization:k}}).then(function(e){if(200!==e.status){var n=404===e.status?null:e.data;return n&&""!==n||(n={message:"Unable to communicate with server"}),b.remove("LoginToken"),console.info("Unable to authenticate: "+n.message),a.reject("Unable to authenticate. Reason: "+n.message)}return j&&b.add("LoginToken",l),d.credentials={username:h,password:i},m=e.data,f.info("Authenticatated. Returning user."),c.defaults.headers.common.Authorization=k,f.info("Logged in as "+m.username),g=m,d.currentUser=m,d.$broadcast("login",m),m})):(console.info("Unable to authenticate."),a.reject("No credentials specified or available for authentication."))},getCurrentUser:function(){return g},deauthenticate:function(){c.defaults.headers.common.Authorization=void 0,b.remove("LoginToken"),d.$broadcast("logout",g),g=null,d.currentUser=null,d.$broadcast("afterLogout",g)}}}]),$btmod.factory("MeetingSvc",["$rootScope","PushEventSvc","ParticipantSvc","$log",function(a,b,c,d){var e=[],f=function(a){d.debug("Retrieving room by id [id="+a+"]");var b;for(b=0;b<e.length;b++)if(e[b].id===a)return d.debug("Room found"),e[b];return null},g=function(a,b){var c;if(a&&angular.isArray(a.participants))for(c=0;c<a.participants.length;c++)if(a.participants[c].channel===b)return a.participants[c];return null},h=function(a){var b,c,d,f=0;for(b=0;b<e.length;b++)for(c=0;c<e[b].participants.length;c++)d=e[b].participants[c],angular.isDefined(a)&&a(d)!==!0||f++;return f},i=function(b,c){var g=f(c.id);d.debug("ConfStartEvent [room="+c+"]"),null===g&&(angular.isArray(c.participants)||(c.participants=[]),e.push(c),a.$broadcast("Meeting.Start",c))},j=function(b,c){var d=f(c);null!==d&&(e.splice(e.indexOf(d),1),a.$broadcast("Meeting.End",d))},k=function(b,c,d){var e=f(c),h=g(e,d.channel);null===h&&(e.participants.push(d),a.$broadcast("Meeting.Join",e,d))},l=function(a,b,c){var d=f(b),e=g(d,c.channel);null!==e&&(e.callerId=c.callerId,e.channel=c.channel,e.muted=c.muted,e.phoneNumber=c.phoneNumber,e.name=c.name,e.type=c.type,e.host=c.host)},m=function(b,c,d){var e,h=f(c),i=g(h,d);null!==i&&(e=h.participants.indexOf(i),h.participants.splice(e,1),a.$broadcast("Meeting.Leave",h,i))},n=function(b,c,d){var e=f(c),h=g(e,d);null===h||h.commentRequested||(h.commentRequested=!0,a.$broadcast("Meeting.Change",e,h))},o=function(b,c,d){var e=f(c),h=g(e,d);null!==h&&h.commentRequested&&(h.commentRequested=!1,a.$broadcast("Meeting.Change",e,h))},p=function(b,c,d){var e=f(c),h=g(e,d);null===h||h.muted||(h.muted=!0,a.$broadcast("Meeting.Change",e,h))},q=function(b,c,d){var e=f(c),h=g(e,d);null!==h&&h.muted&&(h.muted=!1,a.$broadcast("Meeting.Change",e,h))},r=function(b,c,f){d.debug("MeetingSvc:handlePhoneBookUpdate"),angular.forEach(e,function(b){angular.forEach(b.participants,function(d){c===d.phoneNumber&&(d.name=f,a.$broadcast("Meeting.Change",b,d))})})};return a.$on("PushEvent.ConferenceStart",i),a.$on("PushEvent.ConferenceEnd",j),a.$on("PushEvent.Join",k),a.$on("PushEvent.Change",l),a.$on("PushEvent.Leave",m),a.$on("PushEvent.CommentRequest",n),a.$on("PushEvent.CommentRequestCancel",o),a.$on("PushEvent.Mute",p),a.$on("PushEvent.Unmute",q),a.$on("PhoneBook.Update",r),{getTotalParticipantsByCommentRequested:function(a){return h(function(b){return b.host!==!0&&b.commentRequested===a})},getTotalParticipantsByMuted:function(a){return h(function(b){return b.host!==!0&&b.muted===a})},getTotalParticipants:function(){return h(function(a){return a.host!==!0})},getTotalRooms:function(){return e.length},getTotalParticipantsByType:function(a){return h(function(b){return b.host!==!0&&b.type===a})},findAllIds:function(){var a,b=[];for(a=0;a<e.length;a++)b.push(e[a].id);return b},hasRoom:function(a){return null!==f(a)},findRoom:function(a){return f(a)},kickByRoomAndChannel:function(a,b){c.kick(a,b.channel)},muteByRoomAndChannel:function(a,b){c.mute(a,b.channel),b.commentRequested=!1},unmuteByRoomAndChannel:function(a,b){c.unmute(a,b.channel),b.commentRequested=!1}}}]),$btmod.factory("ParticipantSvc",["blacktiger","$resource","$log","$http",function(a,b,c,d){var e=b(a.getServiceUrl()+"rooms/:roomid/participants/:id");return{query:function(a){return e.query({roomid:a})},get:function(a,b){return e.get({roomid:a,id:b})},kick:function(a,b){return e.remove({roomid:a,id:b})},mute:function(b,e){var f={muted:!0};return c.info("Muting participant: [room="+b+";id="+e+"]"),d.put(a.getServiceUrl()+"rooms/"+b+"/participants/"+e,f).then(function(){})},unmute:function(b,e){var f={muted:!1};return c.info("Unmuting participant: [room="+b+";id="+e+"]"),d.put(a.getServiceUrl()+"rooms/"+b+"/participants/"+e,f).then(function(){})}}}]),$btmod.factory("PhoneBookSvc",["$http","blacktiger","$rootScope",function(a,b,c){return{updateEntry:function(d,e){return a.put(b.getServiceUrl()+"phonebook/"+d,e).then(function(){c.$broadcast("PhoneBook.Update",d,e)})}}}]),$btmod.factory("PushEventSvc",["$rootScope","StompSvc","RoomSvc","blacktiger","$log","$q",function(a,b,c,d,e,f){var g,h=function(b){e.debug("Push Event received [type="+b.type+"].");var c=b.participant?b.participant.channel:b.channel;switch(b.type){case"ConferenceStart":a.$broadcast("PushEvent.ConferenceStart",b.room,!1);break;case"ConferenceEnd":a.$broadcast("PushEvent.ConferenceEnd",b.roomNo);break;case"Join":case"Change":a.$broadcast("PushEvent."+b.type,b.roomNo,b.participant);break;case"Leave":case"CommentRequest":case"CommentRequestCancel":case"Mute":case"Unmute":a.$broadcast("PushEvent."+b.type,b.roomNo,c);break;default:e.warn("Unknown push event was not broadcast [type="+b.type+"]")}},i=function(){var e=f.defer();return g=b(d.getServiceUrl()+"socket"),g.connect(null,null,function(){c.query("full").$promise.then(function(b){var c=[];angular.forEach(b,function(b){c.push(b),a.$broadcast("PushEvent.ConferenceStart",b,!0)}),1===c.length?g.subscribe("/queue/events/"+c[0].id,function(a){var b=angular.fromJson(a.body);h(b)}):c.length>1&&g.subscribe("/queue/events/*",function(a){var b=angular.fromJson(a.body);h(b)}),a.$broadcast("PushEventSvc.Initialized"),e.resolve()})},function(b){a.$broadcast("PushEventSvc.Lost_Connection",b),e.reject(b)},"/"),e.promise};return{connect:function(){return i()},disconnect:function(){var a=f.defer();return g?g.disconnect(function(){a.resolve()}):a.resolve(),a.promise}}}]),$btmod.factory("RoomSvc",["blacktiger","$resource",function(a,b){var c=b(a.getServiceUrl()+"rooms/:id",{},{put:{method:"PUT"}});return{query:function(a){var b;return a&&(b={mode:a}),c.query(b)},get:function(a){return c.get({id:a})},save:function(a){return c.put({id:a.id},a)},all:function(){return c.all()}}}]),$btmod.factory("SipUserSvc",["$http","blacktiger","$rootScope","$q",function(a,b,c,d){return{create:function(c){return a.post(b.getServiceUrl()+"sipaccounts",c).then(function(a){if(200!==a.status){var b=a.data&&a.data.message?a.data.message:a.status;return d.reject(b)}})},get:function(c,e){var f={key:c};return a({method:"GET",url:b.getServiceUrl()+"sipaccounts/"+e,params:f}).then(function(a){if(200!==a.status){var b=a.data&&a.data.message?a.data.message:a.status;return d.reject(b)}return a.data})}}}]),$btmod.factory("StompSvc",["$rootScope",function(a){function b(a){var b=new SockJS(a);this.stompClient=Stomp.over(b)}var c={};return b.prototype.subscribe=function(b,c){return this.stompClient.subscribe(b,function(){var b=arguments;a.$apply(function(){c(b[0])})})},b.prototype.send=function(a,b,c){this.stompClient.send(a,b,c)},b.prototype.connect=function(b,d,e,f){this.stompClient.connect({},function(b){a.$apply(function(){e.apply(c,b)})},function(b){a.$apply(function(){f.apply(b)})})},b.prototype.disconnect=function(b){this.stompClient.disconnect(function(){var c=arguments;a.$apply(function(){b.apply(c)})})},function(a){return new b(a)}}]),$btmod.factory("SystemSvc",["$http","blacktiger",function(a,b){return{getSystemInfo:function(){return a.get(b.getServiceUrl()+"system/information").success(function(a){return a}).error(function(a){return a})}}}]);